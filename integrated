import socket
import threading
import sys
from tkinter import *
import time

class Client:
    def __init__(self, gui, HOST, PORT):
        self.gui = gui
        self.socket = socket.socket()
        try:
            self.socket.connect((HOST, PORT))
        except ConnectionRefusedError:
            self.gui.show_message(f"Could not connect to server at {HOST}:{PORT}")
            return

        self.name = None
        self.running = True

    def start(self, name):
        self.name = name
        try:
            self.socket.send(self.name.encode())
        except Exception as e:
            self.gui.show_message(f"Failed to send username: {e}")
            return

        threading.Thread(target=self.receive_messages, daemon=True).start()

    def send_message(self, msg):
        if not self.name or not msg.strip():
            return
        try:
            client_message = self.name + ": " + msg
            self.socket.send(client_message.encode())
        except Exception as e:
            self.gui.show_message(f"Failed to send message: {e}")

    def receive_messages(self):
        while self.running:
            try:
                server_message = self.socket.recv(1024).decode()
                if not server_message:
                    self.gui.show_message("Server disconnected.")
                    break
                self.gui.show_message(server_message)
            except Exception as e:
                self.gui.show_message(f"Error receiving message: {e}")
                break

        self.socket.close()
        self.running = False

    def close(self):
        self.running = False
        self.socket.close()

class ChatGUI:
    def __init__(self, root):
        self.root = root
        root.title('Renichat')
        root.geometry('700x600')
        root.config(bg="black")

        self.txt = Text(root, bg="#000000", fg="#ffa500", font='Helvetica 14', width=60)
        self.txt.pack(padx=10, pady=10, fill=BOTH, expand=True)

        self.input_frame = Frame(root, bg="#000000")
        self.input_frame.pack(fill=X, pady=10)

        self.e = Entry(self.input_frame, bg="#2C3E50", fg="#ffa500", font='Helvetica 14', width=55)
        self.e.pack(side=LEFT, padx=10)
        self.e.bind('<Return>', self.send_msg)

        self.send_btn = Button(self.input_frame, text="Send", font='Helvetica 13 bold', bg="#ffa500",
                               command=self.send_msg)
        self.send_btn.pack(side=LEFT, padx=5)

        self.client = None
        self.name = None

        # Prompt for username on start
        self.ask_name()

    def ask_name(self):
        # Simple blocking dialog for username
        self.name = input("Enter your name: ")
        # Connect client with your server's IP and PORT
        self.client = Client(self, '192.168.55.3', 12345)
        if self.client.socket:
            self.client.start(self.name)

    def send_msg(self, event=None):
        message = self.e.get()
        if message.strip() == '':
            return
        date = time.strftime('%H:%M')
        self.txt.insert(END, f"\nYou -> {message} [{date}]")
        self.e.delete(0, END)
        if self.client:
            self.client.send_message(message)

    def show_message(self, msg):
        # Use after to safely update from other threads
        self.txt.after(0, lambda: self.txt.insert(END, f"\n{msg}"))

    def on_closing(self):
        if self.client:
            self.client.close()
        self.root.destroy()

if __name__ == '__main__':
    root = Tk()
    app = ChatGUI(root)
    root.protocol("WM_DELETE_WINDOW", app.on_closing)
    root.mainloop()
